<Window x:Class="FNEV4.Presentation.Views.ImportTraitement.Sage100ImportWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
        xmlns:materialDesign="http://materialdesigninxaml.net/winfx/xaml/themes"
        xmlns:converters="clr-namespace:FNEV4.Presentation.Converters"
        mc:Ignorable="d" 
        Title="Import Exceptionnel Sage 100 v15"
        Height="700" Width="900"
        MinHeight="600" MinWidth="800"
        WindowStartupLocation="CenterOwner"
        Style="{StaticResource MaterialDesignWindow}">

    <Window.Resources>
        <BooleanToVisibilityConverter x:Key="BoolToVisConverter"/>
        <converters:InverseBooleanToVisibilityConverter x:Key="InverseBoolToVisConverter"/>
        <converters:BoolToIconConverter x:Key="BoolToIconConverter"/>
        <converters:BoolToColorConverter x:Key="BoolToColorConverter"/>
        <converters:BoolToStateConverter x:Key="BoolToStateConverter"/>
        <converters:ProcessingTextConverter x:Key="ProcessingTextConverter"/>
        <converters:InverseBooleanConverter x:Key="InverseBooleanConverter"/>
        <converters:BooleanAndConverter x:Key="BooleanAndConverter"/>
        <converters:ProduitsToTooltipConverter x:Key="ProduitsToTooltipConverter"/>
        
        <!-- Nouveaux convertisseurs pour améliorer la DataGrid -->
        <converters:BoolToStatusConverter x:Key="BoolToStatusConverter"/>
        <converters:BoolToYesNoConverter x:Key="BoolToYesNoConverter"/>
        <converters:BoolToLightColorConverter x:Key="BoolToLightColorConverter"/>
        
        <Style x:Key="HeaderTextStyle" TargetType="TextBlock" BasedOn="{StaticResource MaterialDesignHeadline5TextBlock}">
            <Setter Property="Margin" Value="0,0,0,8"/>
            <Setter Property="Foreground" Value="{DynamicResource PrimaryHueMidBrush}"/>
            <Setter Property="FontWeight" Value="Bold"/>
        </Style>
        
        <Style x:Key="StepCardStyle" TargetType="materialDesign:Card">
            <Setter Property="Padding" Value="20"/>
            <Setter Property="Margin" Value="0,0,0,16"/>
            <Setter Property="materialDesign:ShadowAssist.ShadowDepth" Value="Depth2"/>
        </Style>
    </Window.Resources>

    <Grid Margin="24">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- En-tête -->
        <Grid Grid.Row="0" Margin="0,0,0,24">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="Auto"/>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="Auto"/>
            </Grid.ColumnDefinitions>
            
            <materialDesign:PackIcon Grid.Column="0" 
                                   Kind="AlertCircleOutline" 
                                   Width="40" Height="40"
                                   VerticalAlignment="Center"
                                   Foreground="#FF5722"/>
            
            <StackPanel Grid.Column="1" Margin="16,0,0,0" VerticalAlignment="Center">
                <TextBlock Text="Import Exceptionnel Sage 100 v15" 
                         Style="{StaticResource HeaderTextStyle}"/>
                <TextBlock Text="Import spécialisé pour factures Sage 100 v15 avec structure 1 feuille = 1 facture" 
                         Style="{StaticResource MaterialDesignBody1TextBlock}"
                         Foreground="{DynamicResource MaterialDesignBodyLight}"/>
            </StackPanel>
            
            <Button Grid.Column="2" 
                    Style="{StaticResource MaterialDesignOutlinedButton}"
                    Click="CloseButton_Click"
                    VerticalAlignment="Center">
                <StackPanel Orientation="Horizontal">
                    <materialDesign:PackIcon Kind="Close" Width="16" Height="16" Margin="0,0,8,0"/>
                    <TextBlock Text="Fermer"/>
                </StackPanel>
            </Button>
        </Grid>

        <!-- Zone principale -->
        <ScrollViewer Grid.Row="1" VerticalScrollBarVisibility="Auto">
            <StackPanel>
                
                <!-- Section: Dossiers configurés et import automatique -->
                <materialDesign:Card Style="{StaticResource StepCardStyle}" 
                                   Background="{DynamicResource MaterialDesignPaper}">
                    <StackPanel>
                        <Grid Margin="0,0,0,16">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>
                            
                            <materialDesign:PackIcon Kind="FolderCog" 
                                                   Grid.Column="0"
                                                   VerticalAlignment="Center" 
                                                   Margin="0,0,12,0"
                                                   Width="24" Height="24"
                                                   Foreground="{DynamicResource PrimaryHueMidBrush}"/>
                            
                            <StackPanel Grid.Column="1" VerticalAlignment="Center">
                                <TextBlock Text="Dossiers Configurés - Import Automatique" 
                                         Style="{StaticResource MaterialDesignSubtitle1TextBlock}"
                                         FontWeight="Medium"/>
                                <TextBlock Text="Traitement automatisé des fichiers depuis le dossier d'import configuré" 
                                         Style="{StaticResource MaterialDesignCaptionTextBlock}"
                                         Foreground="{DynamicResource MaterialDesignBodyLight}"
                                         Margin="0,2,0,0"/>
                            </StackPanel>
                            
                            <Button Grid.Column="2" 
                                   Style="{StaticResource MaterialDesignRaisedButton}"
                                   Background="{DynamicResource PrimaryHueMidBrush}"
                                   Command="{Binding ScanAndPreviewCommand}"
                                   Margin="0,0,8,0"
                                   Width="110">
                                <StackPanel Orientation="Horizontal">
                                    <materialDesign:PackIcon Kind="MagnifyPlusOutline" Width="18" Height="18" Margin="0,0,8,0"/>
                                    <TextBlock Text="Scanner"/>
                                </StackPanel>
                                <Button.ToolTip>
                                    <ToolTip Content="Scanner le dossier d'import et afficher automatiquement l'aperçu des factures trouvées"/>
                                </Button.ToolTip>
                            </Button>
                            
                            <Button Grid.Column="3" 
                                   Style="{StaticResource MaterialDesignIconButton}"
                                   Command="{Binding OpenConfiguredFoldersCommand}"
                                   Width="40" Height="40">
                                <materialDesign:PackIcon Kind="FolderOpen" Width="20" Height="20"/>
                                <Button.ToolTip>
                                    <ToolTip Content="Ouvrir le dossier d'import dans l'explorateur"/>
                                </Button.ToolTip>
                            </Button>
                        </Grid>
                        
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>
                            
                            <!-- Dossier Import -->
                            <StackPanel Grid.Column="0" Margin="0,0,16,0">
                                <Grid>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="Auto"/>
                                        <ColumnDefinition Width="*"/>
                                    </Grid.ColumnDefinitions>
                                    
                                    <materialDesign:PackIcon Kind="FolderDownload" 
                                                           Grid.Column="0"
                                                           VerticalAlignment="Center" 
                                                           Margin="0,0,8,0"
                                                           Width="16" Height="16"
                                                           Foreground="#4CAF50"/>
                                    
                                    <TextBlock Grid.Column="1" 
                                             Text="Dossier Import" 
                                             Style="{StaticResource MaterialDesignCaptionTextBlock}"
                                             FontWeight="Medium"/>
                                </Grid>
                                
                                <TextBlock Text="{Binding ImportFolderPath}"
                                         Style="{StaticResource MaterialDesignCaptionTextBlock}"
                                         Foreground="{DynamicResource MaterialDesignBodyLight}"
                                         Margin="24,2,0,0"
                                         TextWrapping="Wrap"/>
                            </StackPanel>
                            
                            <!-- Dossier Archive -->
                            <StackPanel Grid.Column="1" Margin="0,0,16,0">
                                <Grid>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="Auto"/>
                                        <ColumnDefinition Width="*"/>
                                    </Grid.ColumnDefinitions>
                                    
                                    <materialDesign:PackIcon Kind="FolderUpload" 
                                                           Grid.Column="0"
                                                           VerticalAlignment="Center" 
                                                           Margin="0,0,8,0"
                                                           Width="16" Height="16"
                                                           Foreground="#2196F3"/>
                                    
                                    <TextBlock Grid.Column="1" 
                                             Text="Dossier Archive" 
                                             Style="{StaticResource MaterialDesignCaptionTextBlock}"
                                             FontWeight="Medium"/>
                                </Grid>
                                
                                <TextBlock Text="{Binding ArchiveFolderPath}"
                                         Style="{StaticResource MaterialDesignCaptionTextBlock}"
                                         Foreground="{DynamicResource MaterialDesignBodyLight}"
                                         Margin="24,2,0,0"
                                         TextWrapping="Wrap"/>
                            </StackPanel>
                            
                            <!-- Fichiers trouvés -->
                            <StackPanel Grid.Column="2">
                                <Grid>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="Auto"/>
                                        <ColumnDefinition Width="*"/>
                                    </Grid.ColumnDefinitions>
                                    
                                    <materialDesign:PackIcon Kind="FileMultiple" 
                                                           Grid.Column="0"
                                                           VerticalAlignment="Center" 
                                                           Margin="0,0,8,0"
                                                           Width="16" Height="16"
                                                           Foreground="#FF9800"/>
                                    
                                    <TextBlock Grid.Column="1" 
                                             Text="Fichiers disponibles" 
                                             Style="{StaticResource MaterialDesignCaptionTextBlock}"
                                             FontWeight="Medium"/>
                                </Grid>
                                
                                <TextBlock Text="{Binding AvailableFilesCount}"
                                         Style="{StaticResource MaterialDesignCaptionTextBlock}"
                                         Foreground="{DynamicResource MaterialDesignBodyLight}"
                                         Margin="24,2,0,0"/>
                            </StackPanel>
                        </Grid>
                    </StackPanel>
                </materialDesign:Card>

                <!-- Section: Import manuel -->
                <materialDesign:Card Style="{StaticResource StepCardStyle}" 
                                   Background="{DynamicResource MaterialDesignPaper}">
                    <StackPanel>
                        <Grid Margin="0,0,0,16">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>
                            
                            <materialDesign:PackIcon Kind="FileImport" 
                                                   Grid.Column="0"
                                                   VerticalAlignment="Center" 
                                                   Margin="0,0,12,0"
                                                   Width="24" Height="24"
                                                   Foreground="#FF5722"/>
                            
                            <StackPanel Grid.Column="1" VerticalAlignment="Center">
                                <TextBlock Text="Import Manuel - Fichier Spécifique" 
                                         Style="{StaticResource MaterialDesignSubtitle1TextBlock}"
                                         FontWeight="Medium"/>
                                <TextBlock Text="Sélectionnez un fichier Excel (.xlsx) spécifique pour l'import" 
                                         Style="{StaticResource MaterialDesignCaptionTextBlock}"
                                         Foreground="{DynamicResource MaterialDesignBodyLight}"
                                         Margin="0,2,0,0"/>
                            </StackPanel>
                            
                            <Button Grid.Column="2" 
                                   Style="{StaticResource MaterialDesignIconButton}"
                                   Command="{Binding ShowHelpCommand}"
                                   Width="40" Height="40">
                                <materialDesign:PackIcon Kind="HelpCircle" Width="20" Height="20"/>
                                <Button.ToolTip>
                                    <ToolTip Content="Aide sur l'import Sage 100 v15"/>
                                </Button.ToolTip>
                            </Button>
                        </Grid>
                        
                        <!-- Sélection de fichier -->
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>
                            
                            <TextBox Grid.Column="0"
                                   Style="{StaticResource MaterialDesignOutlinedTextBox}"
                                   materialDesign:HintAssist.Hint="Chemin du fichier Excel"
                                   materialDesign:HintAssist.HelperText="Sélectionnez un fichier .xlsx avec les factures Sage 100 v15"
                                   Text="{Binding SelectedFilePath, Mode=TwoWay}"
                                   IsReadOnly="True"
                                   Margin="0,0,8,0"/>
                            
                            <Button Grid.Column="1"
                                   Style="{StaticResource MaterialDesignRaisedButton}"
                                   Command="{Binding SelectFileCommand}"
                                   Background="{DynamicResource PrimaryHueMidBrush}"
                                   Margin="0,0,8,0"
                                   IsEnabled="{Binding IsProcessing, Converter={StaticResource InverseBooleanConverter}}">
                                <StackPanel Orientation="Horizontal">
                                    <materialDesign:PackIcon Kind="FolderOpen" Width="16" Height="16" Margin="0,0,8,0"/>
                                    <TextBlock Text="Parcourir"/>
                                </StackPanel>
                            </Button>
                            
                            <Button Grid.Column="2"
                                   Style="{StaticResource MaterialDesignRaisedButton}"
                                   Command="{Binding ValidateFileCommand}"
                                   Background="#FF5722"
                                   IsEnabled="{Binding HasSelectedFile}"
                                   Visibility="{Binding HasSelectedFile, Converter={StaticResource BoolToVisConverter}}">
                                <StackPanel Orientation="Horizontal">
                                    <materialDesign:PackIcon Kind="CheckCircle" Width="16" Height="16" Margin="0,0,8,0"/>
                                    <TextBlock Text="Valider"/>
                                </StackPanel>
                            </Button>
                        </Grid>
                    </StackPanel>
                </materialDesign:Card>

                <!-- Zone d'état de validation/traitement -->
                <materialDesign:Card Style="{StaticResource StepCardStyle}"
                                   Visibility="{Binding HasValidationResult, Converter={StaticResource BoolToVisConverter}}">
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="*"/>
                        </Grid.ColumnDefinitions>
                        
                        <materialDesign:PackIcon Grid.Column="0"
                                               Kind="{Binding ValidationIcon}"
                                               Width="32" Height="32"
                                               Foreground="{Binding ValidationColor}"
                                               VerticalAlignment="Center"
                                               Margin="0,0,16,0"/>
                        
                        <StackPanel Grid.Column="1" VerticalAlignment="Center">
                            <TextBlock Text="{Binding ValidationMessage}"
                                     Style="{StaticResource MaterialDesignSubtitle1TextBlock}"
                                     FontWeight="Medium"/>
                            <TextBlock Text="{Binding ValidationDetails}"
                                     Style="{StaticResource MaterialDesignBody2TextBlock}"
                                     Foreground="{DynamicResource MaterialDesignBodyLight}"
                                     Margin="0,4,0,0"/>
                        </StackPanel>
                    </Grid>
                </materialDesign:Card>

                <!-- Indicateur de fichier sélectionné -->
                <materialDesign:Card Style="{StaticResource StepCardStyle}"
                                           Visibility="{Binding HasSelectedFile, Converter={StaticResource BoolToVisConverter}}">
                            <StackPanel Orientation="Horizontal" HorizontalAlignment="Center">
                                <materialDesign:PackIcon Kind="Information" Width="24" Height="24" 
                                                       Foreground="{DynamicResource PrimaryHueMidBrush}"
                                                       VerticalAlignment="Center" Margin="0,0,12,0"/>
                                <TextBlock Text="Fichier sélectionné. L'aperçu se lancera automatiquement après validation."
                                         FontSize="14" VerticalAlignment="Center"/>
                            </StackPanel>
                        </materialDesign:Card>

                <!-- Résultats import -->
                <materialDesign:Card Style="{StaticResource StepCardStyle}"
                                   Visibility="{Binding HasImportResult, Converter={StaticResource BoolToVisConverter}}">
                    <StackPanel>
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>
                            
                            <materialDesign:PackIcon Grid.Column="0"
                                                   Kind="{Binding ImportResultIcon}"
                                                   Width="32" Height="32"
                                                   Foreground="{Binding ImportResultColor}"
                                                   VerticalAlignment="Top"
                                                   Margin="0,0,16,0"/>
                            
                            <StackPanel Grid.Column="1">
                                <TextBlock Text="{Binding ImportResultMessage}"
                                         Style="{StaticResource MaterialDesignSubtitle1TextBlock}"
                                         FontWeight="Medium"
                                         Margin="0,0,0,8"/>
                                
                                <TextBlock Text="{Binding ImportResultDetails}"
                                         Style="{StaticResource MaterialDesignBody2TextBlock}"
                                         Foreground="{DynamicResource MaterialDesignBodyLight}"
                                         TextWrapping="Wrap"/>
                            </StackPanel>
                        </Grid>
                        
                        <!-- Boutons d'action post-import -->
                        <StackPanel Orientation="Horizontal" 
                                  HorizontalAlignment="Center" 
                                  Margin="0,16,0,0"
                                  Visibility="{Binding ImportSuccessful, Converter={StaticResource BoolToVisConverter}}">
                            
                            <Button Style="{StaticResource MaterialDesignOutlinedButton}"
                                  Command="{Binding OpenReportCommand}"
                                  Margin="0,0,8,0">
                                <StackPanel Orientation="Horizontal">
                                    <materialDesign:PackIcon Kind="FileDocumentOutline" Width="16" Height="16" Margin="0,0,8,0"/>
                                    <TextBlock Text="Voir le rapport"/>
                                </StackPanel>
                            </Button>
                            
                            <Button Style="{StaticResource MaterialDesignOutlinedButton}"
                                  Command="{Binding OpenArchivedFolderCommand}">
                                <StackPanel Orientation="Horizontal">
                                    <materialDesign:PackIcon Kind="FolderOpen" Width="16" Height="16" Margin="0,0,8,0"/>
                                    <TextBlock Text="Ouvrir Archive"/>
                                </StackPanel>
                            </Button>
                        </StackPanel>
                    </StackPanel>
                </materialDesign:Card>

            </StackPanel>
        </ScrollViewer>

        <!-- Barre de progression -->
        <Grid Grid.Row="2" Margin="0,16,0,0">
            <ProgressBar Style="{StaticResource MaterialDesignLinearProgressBar}"
                       IsIndeterminate="True"
                       Height="4"
                       Visibility="{Binding IsProcessing, Converter={StaticResource BoolToVisConverter}}"/>
        </Grid>
    </Grid>
</Window>