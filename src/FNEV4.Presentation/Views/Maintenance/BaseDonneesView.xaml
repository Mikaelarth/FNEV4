<UserControl x:Class="FNEV4.Presentation.Views.Maintenance.BaseDonneesView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:materialDesign="http://materialdesigninxaml.net/winfx/xaml/themes">
    
    <UserControl.Resources>
        <Style TargetType="materialDesign:Card">
            <Setter Property="Margin" Value="8"/>
            <Setter Property="Padding" Value="16"/>
        </Style>
    </UserControl.Resources>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>

        <!-- En-tÃªte -->
        <materialDesign:Card Grid.Row="0">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>
                
                <StackPanel Grid.Column="0" Orientation="Vertical">
                    <TextBlock Text="Gestion de la Base de DonnÃ©es" 
                              Style="{StaticResource MaterialDesignHeadline5TextBlock}"/>
                    <TextBlock Text="Administration et maintenance de la base de donnÃ©es SQLite" 
                              Style="{StaticResource MaterialDesignCaptionTextBlock}" 
                              Opacity="0.7"/>
                </StackPanel>

                <StackPanel Grid.Column="1" Orientation="Horizontal">
                    <Button Style="{StaticResource MaterialDesignIconButton}"
                            ToolTip="Actualiser"
                            Command="{Binding RefreshCommand}">
                        <materialDesign:PackIcon Kind="Refresh"/>
                    </Button>
                    <Button Style="{StaticResource MaterialDesignIconButton}"
                            ToolTip="ParamÃ¨tres"
                            Command="{Binding SettingsCommand}">
                        <materialDesign:PackIcon Kind="Settings"/>
                    </Button>
                </StackPanel>
            </Grid>
        </materialDesign:Card>

        <!-- Contenu principal -->
        <ScrollViewer Grid.Row="1" VerticalScrollBarVisibility="Auto">
            <StackPanel>
                
                <!-- Informations de la base de donnÃ©es -->
                <materialDesign:Card>
                    <Expander Header="Informations de la Base de DonnÃ©es" IsExpanded="True">
                        <Expander.HeaderTemplate>
                            <DataTemplate>
                                <StackPanel Orientation="Horizontal">
                                    <materialDesign:PackIcon Kind="Database" 
                                                           VerticalAlignment="Center" 
                                                           Margin="0,0,8,0"/>
                                    <TextBlock Text="{Binding}" VerticalAlignment="Center"/>
                                </StackPanel>
                            </DataTemplate>
                        </Expander.HeaderTemplate>
                        
                        <Grid Margin="0,16,0,0">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>
                            
                            <StackPanel Grid.Column="0">
                                <Grid Margin="0,8">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="Auto"/>
                                        <ColumnDefinition Width="*"/>
                                    </Grid.ColumnDefinitions>
                                    <TextBlock Grid.Column="0" Text="Chemin :" FontWeight="Bold" Width="120"/>
                                    <TextBlock Grid.Column="1" Text="{Binding DatabasePath}" TextWrapping="Wrap"/>
                                </Grid>
                                
                                <Grid Margin="0,8">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="Auto"/>
                                        <ColumnDefinition Width="*"/>
                                    </Grid.ColumnDefinitions>
                                    <TextBlock Grid.Column="0" Text="Taille :" FontWeight="Bold" Width="120"/>
                                    <TextBlock Grid.Column="1" Text="{Binding DatabaseSize}"/>
                                </Grid>
                                
                                <Grid Margin="0,8">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="Auto"/>
                                        <ColumnDefinition Width="*"/>
                                    </Grid.ColumnDefinitions>
                                    <TextBlock Grid.Column="0" Text="Version :" FontWeight="Bold" Width="120"/>
                                    <TextBlock Grid.Column="1" Text="{Binding DatabaseVersion}"/>
                                </Grid>
                            </StackPanel>
                            
                            <StackPanel Grid.Column="1">
                                <Grid Margin="0,8">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="Auto"/>
                                        <ColumnDefinition Width="*"/>
                                    </Grid.ColumnDefinitions>
                                    <TextBlock Grid.Column="0" Text="Ã‰tat :" FontWeight="Bold" Width="120"/>
                                    <StackPanel Grid.Column="1" Orientation="Horizontal">
                                        <Ellipse Width="8" Height="8" 
                                               Fill="{Binding ConnectionStatusColor}" 
                                               VerticalAlignment="Center" 
                                               Margin="0,0,8,0"/>
                                        <TextBlock Text="{Binding ConnectionStatus}" VerticalAlignment="Center"/>
                                    </StackPanel>
                                </Grid>
                                
                                <Grid Margin="0,8">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="Auto"/>
                                        <ColumnDefinition Width="*"/>
                                    </Grid.ColumnDefinitions>
                                    <TextBlock Grid.Column="0" Text="DerniÃ¨re sauvegarde :" FontWeight="Bold" Width="120"/>
                                    <TextBlock Grid.Column="1" Text="{Binding LastBackupDate}"/>
                                </Grid>
                                
                                <Grid Margin="0,8">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="Auto"/>
                                        <ColumnDefinition Width="*"/>
                                    </Grid.ColumnDefinitions>
                                    <TextBlock Grid.Column="0" Text="Nb de tables :" FontWeight="Bold" Width="120"/>
                                    <TextBlock Grid.Column="1" Text="{Binding TableCount}"/>
                                </Grid>
                            </StackPanel>
                        </Grid>
                    </Expander>
                </materialDesign:Card>

                <!-- Structure des tables -->
                <materialDesign:Card>
                    <Expander Header="Structure des Tables">
                        <Expander.HeaderTemplate>
                            <DataTemplate>
                                <StackPanel Orientation="Horizontal">
                                    <materialDesign:PackIcon Kind="Table" 
                                                           VerticalAlignment="Center" 
                                                           Margin="0,0,8,0"/>
                                    <TextBlock Text="{Binding}" VerticalAlignment="Center"/>
                                </StackPanel>
                            </DataTemplate>
                        </Expander.HeaderTemplate>
                        
                        <Grid Margin="0,16,0,0">
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="*"/>
                            </Grid.RowDefinitions>
                            
                            <!-- Filtres -->
                            <Grid Grid.Row="0" Margin="0,0,0,16">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="Auto"/>
                                </Grid.ColumnDefinitions>
                                
                                <TextBox Grid.Column="0"
                                        materialDesign:HintAssist.Hint="Rechercher une table..."
                                        Text="{Binding TableSearchText, UpdateSourceTrigger=PropertyChanged}"
                                        Style="{StaticResource MaterialDesignOutlinedTextBox}"/>
                                
                                <Button Grid.Column="1" 
                                       Content="Actualiser les tables"
                                       Style="{StaticResource MaterialDesignOutlinedButton}"
                                       Command="{Binding RefreshTablesCommand}"
                                       Margin="8,0,0,0"/>
                            </Grid>
                            
                            <!-- Liste des tables -->
                            <DataGrid Grid.Row="1" 
                                     ItemsSource="{Binding Tables}"
                                     AutoGenerateColumns="False"
                                     CanUserAddRows="False"
                                     CanUserDeleteRows="False"
                                     IsReadOnly="True"
                                     materialDesign:DataGridAssist.CellPadding="8"
                                     materialDesign:DataGridAssist.ColumnHeaderPadding="8">
                                <DataGrid.Columns>
                                    <DataGridTextColumn Header="Nom de la table" 
                                                       Binding="{Binding Name}" 
                                                       Width="200"/>
                                    <DataGridTextColumn Header="Nombre de lignes" 
                                                       Binding="{Binding RowCount}" 
                                                       Width="120"/>
                                    <DataGridTextColumn Header="Taille" 
                                                       Binding="{Binding Size}" 
                                                       Width="100"/>
                                    <DataGridTextColumn Header="DerniÃ¨re modification" 
                                                       Binding="{Binding LastModified}" 
                                                       Width="150"/>
                                    <DataGridTemplateColumn Width="160">
                                        <DataGridTemplateColumn.Header>
                                            <TextBlock Text="Actions" HorizontalAlignment="Right" Margin="0,0,20,0"/>
                                        </DataGridTemplateColumn.Header>
                                        <DataGridTemplateColumn.CellTemplate>
                                            <DataTemplate>
                                                <StackPanel Orientation="Horizontal" 
                                                           HorizontalAlignment="Right"
                                                           Margin="0,0,20,0">
                                                    <Button Style="{StaticResource MaterialDesignIconButton}"
                                                           ToolTip="Afficher les donnÃ©es de cette table"
                                                           Command="{Binding DataContext.ViewTableDataCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                                           CommandParameter="{Binding}"
                                                           Margin="2">
                                                        <materialDesign:PackIcon Kind="Eye" Width="20" Height="20"/>
                                                    </Button>
                                                    <Border Width="1" Height="16" 
                                                           Background="{DynamicResource MaterialDesignDivider}" 
                                                           Margin="4,0"/>
                                                    <Button Style="{StaticResource MaterialDesignIconButton}"
                                                           ToolTip="Afficher la structure de cette table"
                                                           Command="{Binding DataContext.ViewTableStructureCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                                           CommandParameter="{Binding}"
                                                           Margin="2">
                                                        <materialDesign:PackIcon Kind="FileTree" Width="20" Height="20"/>
                                                    </Button>
                                                </StackPanel>
                                            </DataTemplate>
                                        </DataGridTemplateColumn.CellTemplate>
                                    </DataGridTemplateColumn>
                                </DataGrid.Columns>
                            </DataGrid>
                        </Grid>
                    </Expander>
                </materialDesign:Card>

                <!-- Outils de maintenance -->
                <materialDesign:Card>
                    <Expander Header="Outils de Maintenance">
                        <Expander.HeaderTemplate>
                            <DataTemplate>
                                <StackPanel Orientation="Horizontal">
                                    <materialDesign:PackIcon Kind="Tools" 
                                                           VerticalAlignment="Center" 
                                                           Margin="0,0,8,0"/>
                                    <TextBlock Text="{Binding}" VerticalAlignment="Center"/>
                                </StackPanel>
                            </DataTemplate>
                        </Expander.HeaderTemplate>
                        
                        <Grid Margin="0,16,0,0">
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto"/>
                            </Grid.RowDefinitions>
                            
                            <!-- Sauvegarde et restauration -->
                            <GroupBox Grid.Row="0" Header="Sauvegarde et Restauration" Margin="0,0,0,16">
                                <StackPanel>
                                    <Grid Margin="0,8">
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="*"/>
                                            <ColumnDefinition Width="Auto"/>
                                            <ColumnDefinition Width="Auto"/>
                                        </Grid.ColumnDefinitions>
                                        
                                        <TextBlock Grid.Column="0" 
                                                  Text="CrÃ©er une sauvegarde complÃ¨te de la base de donnÃ©es" 
                                                  VerticalAlignment="Center"/>
                                        
                                        <Button Grid.Column="1" 
                                               Content="Sauvegarder"
                                               Style="{StaticResource MaterialDesignRaisedButton}"
                                               Command="{Binding BackupDatabaseCommand}"
                                               Margin="8,0,0,0"/>
                                        
                                        <Button Grid.Column="2" 
                                               Content="Restaurer"
                                               Style="{StaticResource MaterialDesignOutlinedButton}"
                                               Command="{Binding RestoreDatabaseCommand}"
                                               Margin="8,0,0,0"/>
                                    </Grid>
                                    
                                    <CheckBox Content="Sauvegarde automatique quotidienne" 
                                             IsChecked="{Binding AutoBackupEnabled}"
                                             Margin="0,8"/>
                                </StackPanel>
                            </GroupBox>
                            
                            <!-- Optimisation -->
                            <GroupBox Grid.Row="1" Header="Optimisation" Margin="0,0,0,16">
                                <StackPanel>
                                    <Grid Margin="0,8">
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="*"/>
                                            <ColumnDefinition Width="Auto"/>
                                        </Grid.ColumnDefinitions>
                                        
                                        <TextBlock Grid.Column="0" 
                                                  Text="Optimiser la base de donnÃ©es (VACUUM)" 
                                                  VerticalAlignment="Center"/>
                                        
                                        <Button Grid.Column="1" 
                                               Content="Optimiser"
                                               Style="{StaticResource MaterialDesignRaisedButton}"
                                               Command="{Binding OptimizeDatabaseCommand}"
                                               Margin="8,0,0,0"/>
                                    </Grid>
                                    
                                    <Grid Margin="0,8">
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="*"/>
                                            <ColumnDefinition Width="Auto"/>
                                        </Grid.ColumnDefinitions>
                                        
                                        <TextBlock Grid.Column="0" 
                                                  Text="RÃ©indexer toutes les tables" 
                                                  VerticalAlignment="Center"/>
                                        
                                        <Button Grid.Column="1" 
                                               Content="RÃ©indexer"
                                               Style="{StaticResource MaterialDesignOutlinedButton}"
                                               Command="{Binding ReindexDatabaseCommand}"
                                               Margin="8,0,0,0"/>
                                    </Grid>
                                    
                                    <Grid Margin="0,8">
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="*"/>
                                            <ColumnDefinition Width="Auto"/>
                                        </Grid.ColumnDefinitions>
                                        
                                        <TextBlock Grid.Column="0" 
                                                  Text="Analyser l'intÃ©gritÃ© de la base" 
                                                  VerticalAlignment="Center"/>
                                        
                                        <Button Grid.Column="1" 
                                               Content="Analyser"
                                               Style="{StaticResource MaterialDesignOutlinedButton}"
                                               Command="{Binding CheckIntegrityCommand}"
                                               Margin="8,0,0,0"/>
                                    </Grid>
                                </StackPanel>
                            </GroupBox>
                            
                            <!-- Migration et initialisation -->
                            <GroupBox Grid.Row="2" Header="Migration et Initialisation">
                                <StackPanel>
                                    <Grid Margin="0,8">
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="*"/>
                                            <ColumnDefinition Width="Auto"/>
                                        </Grid.ColumnDefinitions>
                                        
                                        <TextBlock Grid.Column="0" 
                                                  Text="Appliquer les migrations en attente" 
                                                  VerticalAlignment="Center"/>
                                        
                                        <Button Grid.Column="1" 
                                               Content="Migrer"
                                               Style="{StaticResource MaterialDesignRaisedButton}"
                                               Command="{Binding ApplyMigrationsCommand}"
                                               Margin="8,0,0,0"/>
                                    </Grid>
                                    
                                    <Grid Margin="0,8">
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="*"/>
                                            <ColumnDefinition Width="Auto"/>
                                        </Grid.ColumnDefinitions>
                                        
                                        <TextBlock Grid.Column="0" 
                                                  Text="RÃ©initialiser la base de donnÃ©es vide" 
                                                  VerticalAlignment="Center"/>
                                        
                                        <Button Grid.Column="1" 
                                               Content="RÃ©initialiser"
                                               Style="{StaticResource MaterialDesignOutlinedButton}"
                                               Command="{Binding InitializeDatabaseCommand}"
                                               Margin="8,0,0,0"/>
                                    </Grid>
                                    
                                    <TextBlock Text="âš ï¸ Attention : La rÃ©initialisation supprimera toutes les donnÃ©es existantes" 
                                              Foreground="Orange" 
                                              FontStyle="Italic" 
                                              Margin="0,8"/>
                                </StackPanel>
                            </GroupBox>
                        </Grid>
                    </Expander>
                </materialDesign:Card>

                <!-- Console SQL avancÃ©e -->
                <materialDesign:Card>
                    <Expander Header="Console SQL" IsExpanded="False">
                        <Expander.HeaderTemplate>
                            <DataTemplate>
                                <StackPanel Orientation="Horizontal">
                                    <materialDesign:PackIcon Kind="Console" 
                                                           VerticalAlignment="Center" 
                                                           Margin="0,0,8,0"/>
                                    <TextBlock Text="{Binding}" VerticalAlignment="Center"/>
                                    <TextBlock Text=" - ExÃ©cution de requÃªtes personnalisÃ©es" 
                                              VerticalAlignment="Center" 
                                              FontStyle="Italic" 
                                              Opacity="0.7"
                                              Margin="8,0,0,0"/>
                                </StackPanel>
                            </DataTemplate>
                        </Expander.HeaderTemplate>
                        
                        <Grid Margin="0,16,0,0">
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="200"/>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="*"/>
                            </Grid.RowDefinitions>
                            
                            <!-- En-tÃªte avec aide -->
                            <Border Grid.Row="0" 
                                   Background="{DynamicResource MaterialDesignCardBackground}"
                                   BorderBrush="{DynamicResource MaterialDesignDivider}"
                                   BorderThickness="1"
                                   CornerRadius="4"
                                   Padding="12"
                                   Margin="0,0,0,8">
                                <StackPanel>
                                    <TextBlock Text="ðŸ’» Console SQL - ExÃ©cution de requÃªtes" 
                                              FontWeight="Bold" 
                                              FontSize="14"/>
                                    <TextBlock Text="Saisissez votre requÃªte SQL ci-dessous. Soyez prudent avec les requÃªtes de modification (UPDATE, DELETE, DROP)." 
                                              TextWrapping="Wrap" 
                                              Opacity="0.8"
                                              Margin="0,4,0,0"/>
                                </StackPanel>
                            </Border>
                            
                            <!-- Zone de saisie SQL amÃ©liorÃ©e -->
                            <Border Grid.Row="1"
                                   BorderBrush="{DynamicResource MaterialDesignDivider}"
                                   BorderThickness="2"
                                   CornerRadius="4">
                                <TextBox Text="{Binding SqlQuery, UpdateSourceTrigger=PropertyChanged}"
                                        AcceptsReturn="True"
                                        TextWrapping="Wrap"
                                        VerticalScrollBarVisibility="Auto"
                                        FontFamily="Consolas"
                                        FontSize="13"
                                        Padding="8"
                                        Background="{DynamicResource MaterialDesignTextFieldBoxBackground}"
                                        materialDesign:HintAssist.Hint="Tapez votre requÃªte SQL ici... (Ex: SELECT * FROM sqlite_master;)"
                                        materialDesign:HintAssist.IsFloating="True"/>
                            </Border>
                            
                            <!-- Boutons d'action amÃ©liorÃ©s -->
                            <StackPanel Grid.Row="2" 
                                       Orientation="Horizontal" 
                                       HorizontalAlignment="Right" 
                                       Margin="0,12,0,8">
                                <Button Content="â–¶ ExÃ©cuter"
                                       Style="{StaticResource MaterialDesignRaisedButton}"
                                       Background="#4CAF50"
                                       Command="{Binding ExecuteSqlCommand}"
                                       ToolTip="ExÃ©cuter la requÃªte SQL"
                                       Margin="0,0,8,0"/>
                                <Button Content="ðŸ—‘ Effacer"
                                       Style="{StaticResource MaterialDesignOutlinedButton}"
                                       Command="{Binding ClearSqlCommand}"
                                       ToolTip="Effacer la requÃªte et les rÃ©sultats"/>
                            </StackPanel>
                            
                            <!-- Zone de rÃ©sultats amÃ©liorÃ©e -->
                            <Border Grid.Row="3"
                                   BorderBrush="{DynamicResource MaterialDesignDivider}"
                                   BorderThickness="1"
                                   CornerRadius="4"
                                   Background="{DynamicResource MaterialDesignCardBackground}">
                                <ScrollViewer VerticalScrollBarVisibility="Auto" 
                                             MaxHeight="400"
                                             Padding="8">
                                    <TextBox Text="{Binding SqlResults}"
                                            IsReadOnly="True"
                                            FontFamily="Consolas"
                                            FontSize="12"
                                            Background="Transparent"
                                            BorderThickness="0"
                                            TextWrapping="Wrap"
                                            Foreground="{DynamicResource MaterialDesignBody}"/>
                                </ScrollViewer>
                            </Border>
                        </Grid>
                    </Expander>
                </materialDesign:Card>

            </StackPanel>
        </ScrollViewer>
    </Grid>
</UserControl>
